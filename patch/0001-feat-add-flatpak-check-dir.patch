From 3e7d5f4395d26b9b9ae4665018cd67d1dfee12c0 Mon Sep 17 00:00:00 2001
From: Iceyer <me@iceyer.net>
Date: Mon, 13 Nov 2017 17:16:36 +0800
Subject: [PATCH] feat: add flatpak check dir

Change-Id: Ib1fb59b35a64822e55837a44e9fd4fecdddf5f0c
---
 src/widgets/dapplication.cpp | 22 ++++++++++++++++++++--
 src/widgets/dtitlebar.cpp    |  7 ++++---
 2 files changed, 24 insertions(+), 5 deletions(-)

diff --git a/src/widgets/dapplication.cpp b/src/widgets/dapplication.cpp
index 47c7501..3d6c2ab 100644
--- a/src/widgets/dapplication.cpp
+++ b/src/widgets/dapplication.cpp
@@ -32,6 +32,10 @@
 #include <QDBusConnection>
 #endif
 
+#include <QDBusInterface>
+#include <QDBusConnection>
+#include <QDBusReply>
+
 #include <qpa/qplatformintegrationfactory_p.h>
 
 #include <DStandardPaths>
@@ -545,8 +549,22 @@ void DApplication::setAboutDialog(DAboutDialog *aboutDialog)
  */
 void DApplication::handleHelpAction()
 {
-    const QString appName = applicationName();
-    QProcess::startDetached("dman", QStringList() << appName);
+    QString appid = applicationName();
+    if (!qgetenv("FLATPAK_APPID").isEmpty()) {
+        appid = qgetenv("FLATPAK_APPID");
+    }
+
+    QDBusInterface dmanInterface("com.deepin.dman",
+                                 "/com/deepin/dman",
+                                 "com.deepin.dman");
+    if (dmanInterface.isValid()) {
+        auto reply = dmanInterface.call("ShowManual", appid);
+        if (dmanInterface.lastError().isValid()) {
+            qCritical() << "failed call ShowManual" << appid << dmanInterface.lastError();
+        }
+    } else {
+        qCritical() << "can not create dman dbus interface";
+    }
 }
 
 /**
diff --git a/src/widgets/dtitlebar.cpp b/src/widgets/dtitlebar.cpp
index 79bfa51..ebd96bb 100644
--- a/src/widgets/dtitlebar.cpp
+++ b/src/widgets/dtitlebar.cpp
@@ -389,9 +389,10 @@ void DTitlebarPrivate::_q_quitActionTriggered()
 bool DTitlebarPrivate::isUserManualExists() const
 {
     const QString appName = qApp->applicationName();
-
-    return QFile::exists("/usr/bin/dman") && \
-           QFile::exists("/usr/share/dman/" + appName);
+    bool dmanAppExists = QFile::exists("/usr/bin/dman");
+    bool dmanDataExists = QFile::exists("/usr/share/dman/" + appName) || \
+                          QFile::exists("/app/share/dman/" + appName);
+    return  dmanAppExists && dmanDataExists;
 }
 
 #endif
-- 
2.13.3

