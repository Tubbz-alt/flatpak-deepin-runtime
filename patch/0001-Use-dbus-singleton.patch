From 97784f731e9ba23b1ef2384f7004bc586e3e3e53 Mon Sep 17 00:00:00 2001
From: iceyer <me@iceyer.net>
Date: Thu, 21 Sep 2017 13:59:57 +0800
Subject: [PATCH] Use dbus singleton

Change-Id: I1cca4aa1245211bcf1b00676695bebc48c2612cf
---
 src/widgets/dapplication.cpp         | 29 +++++++++++++++++++++++++----
 src/widgets/dsimplecombobox.h        |  2 +-
 src/widgets/private/dapplication_p.h |  1 +
 3 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/src/widgets/dapplication.cpp b/src/widgets/dapplication.cpp
index 91f6292..cedfd7e 100644
--- a/src/widgets/dapplication.cpp
+++ b/src/widgets/dapplication.cpp
@@ -41,6 +41,12 @@
 #include "startupnotificationmonitor.h"
 #endif
 
+#define DBUS_SINGLEINSTANCE
+#ifdef DBUS_SINGLEINSTANCE
+#include <QDBusError>
+#include <QDBusConnection>
+#endif
+
 #define DXCB_PLUGIN_KEY "dxcb"
 
 DCORE_USE_NAMESPACE
@@ -146,8 +152,9 @@ bool DApplicationPrivate::setSingleInstanceBySemaphore(const QString &key)
     static QSystemSemaphore ss(key, 1, QSystemSemaphore::Open);
     static bool singleInstance = false;
 
-    if (singleInstance)
+    if (singleInstance) {
         return true;
+    }
 
     Q_ASSERT_X(ss.error() == QSystemSemaphore::NoError, "DApplicationPrivate::setSingleInstanceBySemaphore:", ss.errorString().toLocal8Bit().constData());
 
@@ -155,9 +162,11 @@ bool DApplicationPrivate::setSingleInstanceBySemaphore(const QString &key)
 
     if (singleInstance) {
         QtConcurrent::run([] {
-            while (ss.acquire() && singleInstance) {
-                if (qApp->startingUp() || qApp->closingDown())
+            while (ss.acquire() && singleInstance)
+            {
+                if (qApp->startingUp() || qApp->closingDown()) {
                     break;
+                }
 
                 ss.release(1);
 
@@ -177,6 +186,18 @@ bool DApplicationPrivate::setSingleInstanceBySemaphore(const QString &key)
     return singleInstance;
 }
 
+bool DApplicationPrivate::setSingleInstanceByDbus(const QString &key)
+{
+    auto basename = "com.deepin.SingleInstance.";
+    QString name = basename + key;
+    auto sessionBus = QDBusConnection::sessionBus();
+    if (!sessionBus.registerService(name)) {
+        qDebug() << "register service failed:" << sessionBus.lastError();
+        return  false;
+    }
+    return true;
+}
+
 bool DApplicationPrivate::loadDtkTranslator(QList<QLocale> localeFallback)
 {
     D_Q(DApplication);
@@ -296,7 +317,7 @@ bool DApplication::setSingleInstance(const QString &key)
 {
     D_D(DApplication);
 
-    return d->setSingleInstanceBySemaphore(key);
+    return d->setSingleInstanceByDbus(key);
 }
 
 //! load translate file form system or application data path;
diff --git a/src/widgets/dsimplecombobox.h b/src/widgets/dsimplecombobox.h
index aefbf8a..ab3e6fa 100644
--- a/src/widgets/dsimplecombobox.h
+++ b/src/widgets/dsimplecombobox.h
@@ -27,7 +27,7 @@
 
 DWIDGET_BEGIN_NAMESPACE
 
-class LIBDTKWIDGETSHARED_EXPORT DSimpleComboBox : public DComboBox
+class LIBDTKWIDGETSHARED_EXPORT  Q_DECL_DEPRECATED_X("Use QCombobBox directly.") DSimpleComboBox : public DComboBox
 {
     Q_OBJECT
 public:
diff --git a/src/widgets/private/dapplication_p.h b/src/widgets/private/dapplication_p.h
index 3e4bf6d..7c0d78b 100644
--- a/src/widgets/private/dapplication_p.h
+++ b/src/widgets/private/dapplication_p.h
@@ -46,6 +46,7 @@ public:
 
     bool setSingleInstance(const QString &key);
     bool setSingleInstanceBySemaphore(const QString &key);
+    bool setSingleInstanceByDbus(const QString &key);
 
     bool loadDtkTranslator(QList<QLocale> localeFallback);
     bool loadTranslator(QList<DPathBuf> translateDirs, const QString &name, QList<QLocale> localeFallback);
-- 
2.11.0

